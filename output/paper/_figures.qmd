<!-- title: "Figures" -->

<!-- format: -->
<!--   docx: -->
<!--     reference-doc: reference_document.docx -->
<!--   pdf: -->
<!--     pdf-engine: lualatex -->
<!--     number-sections: true -->
<!--     toc: false -->
<!--     include-in-header: -->
<!--       text: | -->
<!--         \usepackage{lineno} -->
<!--         \usepackage{rotating} -->
<!--         \usepackage{float} -->
<!--         \usepackage{typearea} -->
<!--     include-before-body: -->
<!--       text: | -->
<!--         \linenumbers -->

<!-- link-citations: true -->
<!-- linkcolor: blue -->

<!-- editor_options: -->
<!--   chunk_output_type: console -->

<!-- execute: -->
<!--   echo: false -->
<!--   warning: false -->
<!--   error: false -->
<!--   message: false -->

```{r}
here::i_am("output/paper/_figures.qmd")
```

```{r}
# Function to align forest plot with table numerical results
forest_plot <- function(obj, r = 4, is_cortisol = FALSE) {
  edcs <- myphd::edcs_information() |>
    dplyr::filter(!chem_id %in% c("dedtp", "dmdtp")) |>
    dplyr::select(chem_id, short_name, class) |>
    dplyr::bind_rows(
      tibble::tibble(
        chem_id = c("Exposure"),
        short_name = c("Exposure"),
        class = c(NULL)
      )
    )
  
  # From table of numerical results to ggplot object
  tbl_num_res <- obj$numerical_results
  if (is_cortisol == FALSE) {
    tbl_num_res <- tbl_num_res |>
    dplyr::left_join(
      edcs[, c("chem_id", "short_name")],
      by = c("variable" = "chem_id")
    ) |>
    dplyr::select(-variable) |>
    dplyr::rename(variable = "short_name") |>
    dplyr::relocate(variable)
  }
  tbl_num_res <- tbl_num_res |>
    tidylog::mutate(
      variable = forcats::fct_reorder2(
        variable, estimate, class
      )
    ) |>
    tidylog::select(-estimate) |>
    ggplot2::ggplot(
      ggplot2::aes(
        y = variable,
        shape = outcome
      )
    ) +
    ggplot2::geom_text(
      ggplot2::aes(
        x = 0,
        label = variable
      ),
      hjust = 0,
      fontface = "bold"
    ) +
    ggplot2::geom_text(
      ggplot2::aes(
        x = 1,
        label = val
      ),
      hjust = 0,
      position = ggstance::position_dodgev(height = 0.9)
    ) +
    ggplot2::theme_void() +
    ggplot2::theme(
      strip.background = ggplot2::element_blank(),
      strip.text = ggplot2::element_blank(),
      legend.position = "bottom",
      legend.box = "vertical",
      legend.margin = ggplot2::margin()
    ) +
    ggplot2::coord_cartesian(
      xlim = c(0, 4)
    )
  
  # Assemble elements
  ret <- patchwork::wrap_plots(
    tbl_num_res, obj$plot
  ) +
    patchwork::plot_layout(
      design = c(
        patchwork::area(t = 0, l = 1, b = 3, r = r),
        patchwork::area(t = 1, l = r, b = 3, r = r + 4)
      )
    )
  
  return(ret)
} # End function forest_plot
```

# Figures for main results

## Marginal contrasts

```{r}
targets::tar_load(
  dplyr::matches("marginal_comparisons_(\\d)$"),
  store = store
)
```

::: {#fig-marginal-1}
```{r marginal-1}
#| fig-width: 9
#| fig-height: 10

obj1 <- tidy_res_meffects(
  df = marginal_comparisons_1,
  sa_var = NULL,
  outcome = c("hitrtse"),
  which_res = "comparisons",
  num_digits_est = num_digits_est,
  num_digits_sig = num_digits_sig
)
forest_plot(obj = obj1)
```
**Marginal contrasts for the effect of a decrease from the 90th to the 10th percentile of the {{< acr edcs >}} on {{< acr hitrtse >}} expressed in {{< acr mss >}} (HELIX subcohort; 2013-2016).** 
Circles indicate effect estimates. Solid lines indicate the $95\%$ {{< acr ci >}}.
:::

::: {#fig-marginal-2}
```{r marginal-2}
#| fig-width: 9
#| fig-height: 12

obj2 <- tidy_res_meffects(
  df = marginal_comparisons_2,
  sa_var = NULL,
  outcome = c(
    "cortisol production",
    "cortisone production",
    "corticosterone production"
  ),
  which_res = "comparisons",
  num_digits_est = num_digits_est,
  num_digits_sig = num_digits_sig
)
forest_plot(obj = obj2)
```
**Marginal contrasts for the effect of a decrease from the 90th to the 10th percentile of the {{< acr edcs >}} on the glucocorticosteroids expressed in ng/ml (HELIX subcohort; 2013-2016).** 
Circles, triangles, and squares indicate effect estimates. Solid lines indicate the $95\%$ {{< acr ci >}}.
:::

::: {#fig-marginal-3}
```{r marginal-3}
#| fig-width: 9
#| fig-height: 5

obj3 <- tidy_res_meffects(
  df = marginal_comparisons_3,
  sa_var = NULL,
  outcome = c("hitrtse"),
  which_res = "comparisons",
  num_digits_est = num_digits_est,
  num_digits_sig = num_digits_sig
)
forest_plot(obj = obj3, r = 5, is_cortisol = TRUE)
```
**Marginal contrasts for the effect of a decrease from the 90th to the 10th percentile of the glucocorticosteroids on {{< acr hitrtse >}} expressed in {{< acr mss >}} (HELIX subcohort; 2013-2016).** 
Circles indicate effect estimates. Solid lines indicate the $95\%$ {{< acr ci >}}. Abbreviations: cortisone production (cortisone prod.); cortisol production (cortisol prod.); corticost. prod. (corticosterone production).
:::
