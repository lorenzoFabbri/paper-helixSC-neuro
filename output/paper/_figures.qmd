<!-- title: "Figures" -->

<!-- format: -->
<!--   docx: -->
<!--     reference-doc: reference_document.docx -->
<!--   pdf: -->
<!--     pdf-engine: lualatex -->
<!--     number-sections: true -->
<!--     toc: false -->
<!--     include-in-header: -->
<!--       text: | -->
<!--         \usepackage{lineno} -->
<!--         \usepackage{rotating} -->
<!--         \usepackage{float} -->
<!--         \usepackage{typearea} -->
<!--     include-before-body: -->
<!--       text: | -->
<!--         \linenumbers -->

<!-- link-citations: true -->
<!-- linkcolor: blue -->

<!-- editor_options: -->
<!--   chunk_output_type: console -->

<!-- execute: -->
<!--   echo: false -->
<!--   warning: false -->
<!--   error: false -->
<!--   message: false -->

```{r}
here::i_am("output/paper/_figures.qmd")
```

```{r}
# Function to align forest plot with table numerical results
forest_plot <- function(obj, r = 4) {
  # From table of numerical results to ggplot object
  tbl_num_res <- obj$numerical_results |>
    tidylog::mutate(
      variable = forcats::fct_reorder2(
        variable, estimate, class
      )
    ) |>
    tidylog::select(-estimate) |>
    ggplot2::ggplot(
      ggplot2::aes(
        y = variable,
        shape = outcome
      )
    ) +
    ggplot2::geom_text(
      ggplot2::aes(
        x = 0,
        label = variable
      ),
      hjust = 0,
      fontface = "bold"
    ) +
    ggplot2::geom_text(
      ggplot2::aes(
        x = 1,
        label = val
      ),
      hjust = 0,
      position = ggstance::position_dodgev(height = 0.9)
    ) +
    ggplot2::theme_void() +
    ggplot2::theme(
      strip.background = ggplot2::element_blank(),
      strip.text = ggplot2::element_blank(),
      legend.position = "bottom",
      legend.box = "vertical",
      legend.margin = ggplot2::margin()
    ) +
    ggplot2::coord_cartesian(
      xlim = c(0, 4)
    )
  
  # Assemble elements
  ret <- patchwork::wrap_plots(
    tbl_num_res, obj$plot
  ) +
    patchwork::plot_layout(
      design = c(
        patchwork::area(t = 0, l = 1, b = 3, r = r),
        patchwork::area(t = 1, l = r, b = 3, r = r + 4)
      )
    )
  
  return(ret)
} # End function forest_plot
```

# Figures for main results

## Marginal contrasts

```{r}
targets::tar_load(
  dplyr::matches("marginal_comparisons_(\\d)$"),
  store = store
)
```

::: {#fig-marginal-1}
```{r marginal-1}
#| fig-width: 9
#| fig-height: 10

obj1 <- tidy_res_meffects(
  df = marginal_comparisons_1,
  sa_var = NULL,
  outcome = c("hitrtse"),
  which_res = "comparisons",
  num_digits_est = num_digits_est,
  num_digits_sig = num_digits_sig
)
forest_plot(obj = obj1)
```
**Marginal contrasts (exposures: \acr{edcs}; outcome: \acr{hitrtse}) (HELIX Study; 2013-2016).**
Circles indicate effect estimates. Solid lines indicate the $95\%$ \acr{ci}.
:::

::: {#fig-marginal-2}
```{r marginal-2}
#| fig-width: 9
#| fig-height: 12

obj2 <- tidy_res_meffects(
  df = marginal_comparisons_2,
  sa_var = NULL,
  outcome = c(
    "cortisol production",
    "cortisone production",
    "corticosterone production"
  ),
  which_res = "comparisons",
  num_digits_est = num_digits_est,
  num_digits_sig = num_digits_sig
)
forest_plot(obj = obj2)
```
**Marginal contrasts (exposures: \acr{edcs}; outcomes: glucocorticosteroids) (HELIX Study; 2013-2016).**
Circles, triangles, and squares indicate effect estimates. Solid lines indicate the $95\%$ \acr{ci}.
:::

::: {#fig-marginal-3}
```{r marginal-3}
#| fig-width: 9
#| fig-height: 5

obj3 <- tidy_res_meffects(
  df = marginal_comparisons_3,
  sa_var = NULL,
  outcome = c("hitrtse"),
  which_res = "comparisons",
  num_digits_est = num_digits_est,
  num_digits_sig = num_digits_sig
)
forest_plot(obj = obj3, r = 5)
```
**Marginal contrasts (exposures: glucocorticosteroids; outcome: \acr{hitrtse}) (HELIX Study; 2013-2016).**
Circles indicate effect estimates. Solid lines indicate the $95\%$ \acr{ci}.
:::
